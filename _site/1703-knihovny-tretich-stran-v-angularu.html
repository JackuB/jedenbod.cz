<!DOCTYPE html>
<html ⚡ lang="en">
  <head>
  <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
  <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>Knihovny třetích stran v Angularu</title>
  <meta name="description" content="Při stavění Click and Study s Digital Wizards jsem narazil na to, že moje Angular aplikace závisela na hned několika knihovnách 3. strany. Firebase, Facebook...">

  <link rel="canonical" href="http://jedenbod.cz/1703-knihovny-tretich-stran-v-angularu.html">
  <link rel="alternate" type="application/rss+xml" title="Jedenbod.cz" href="http://jedenbod.cz/feed.xml">

  <script type="application/ld+json">
  
{
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": "http://jedenbod.cz/1703-knihovny-tretich-stran-v-angularu.html",
  "headline": "Knihovny třetích stran v Angularu",
  "datePublished": "2014-11-22T20:31:34+01:00",
  "dateModified": "2014-11-22T20:31:34+01:00",
  "description": "Při stavění Click and Study s Digital Wizards jsem narazil na to, že moje Angular aplikace závisela na hned několika knihovnách 3. strany. Firebase, Facebook...",
  "author": {
    "@type": "Person",
    "name": "Jakub Mikuláš"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Jedenbod.cz",
    "logo": {
      "@type": "ImageObject",
      "url": "http://jedenbod.cz",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "http://jedenbod.cz",
    "height": 60,
    "width": 60
  }
}

  </script>

  <style amp-custom>
  
  /**
 * Syntax highlighting styles
 */
.highlight {
  background: #fff; }
  .highlighter-rouge .highlight {
    background: #eef; }
  .highlight .c {
    color: #998;
    font-style: italic; }
  .highlight .err {
    color: #a61717;
    background-color: #e3d2d2; }
  .highlight .k {
    font-weight: bold; }
  .highlight .o {
    font-weight: bold; }
  .highlight .cm {
    color: #998;
    font-style: italic; }
  .highlight .cp {
    color: #999;
    font-weight: bold; }
  .highlight .c1 {
    color: #998;
    font-style: italic; }
  .highlight .cs {
    color: #999;
    font-weight: bold;
    font-style: italic; }
  .highlight .gd {
    color: #000;
    background-color: #fdd; }
  .highlight .gd .x {
    color: #000;
    background-color: #faa; }
  .highlight .ge {
    font-style: italic; }
  .highlight .gr {
    color: #a00; }
  .highlight .gh {
    color: #999; }
  .highlight .gi {
    color: #000;
    background-color: #dfd; }
  .highlight .gi .x {
    color: #000;
    background-color: #afa; }
  .highlight .go {
    color: #888; }
  .highlight .gp {
    color: #555; }
  .highlight .gs {
    font-weight: bold; }
  .highlight .gu {
    color: #aaa; }
  .highlight .gt {
    color: #a00; }
  .highlight .kc {
    font-weight: bold; }
  .highlight .kd {
    font-weight: bold; }
  .highlight .kp {
    font-weight: bold; }
  .highlight .kr {
    font-weight: bold; }
  .highlight .kt {
    color: #458;
    font-weight: bold; }
  .highlight .m {
    color: #099; }
  .highlight .s {
    color: #d14; }
  .highlight .na {
    color: #008080; }
  .highlight .nb {
    color: #0086B3; }
  .highlight .nc {
    color: #458;
    font-weight: bold; }
  .highlight .no {
    color: #008080; }
  .highlight .ni {
    color: #800080; }
  .highlight .ne {
    color: #900;
    font-weight: bold; }
  .highlight .nf {
    color: #900;
    font-weight: bold; }
  .highlight .nn {
    color: #555; }
  .highlight .nt {
    color: #000080; }
  .highlight .nv {
    color: #008080; }
  .highlight .ow {
    font-weight: bold; }
  .highlight .w {
    color: #bbb; }
  .highlight .mf {
    color: #099; }
  .highlight .mh {
    color: #099; }
  .highlight .mi {
    color: #099; }
  .highlight .mo {
    color: #099; }
  .highlight .sb {
    color: #d14; }
  .highlight .sc {
    color: #d14; }
  .highlight .sd {
    color: #d14; }
  .highlight .s2 {
    color: #d14; }
  .highlight .se {
    color: #d14; }
  .highlight .sh {
    color: #d14; }
  .highlight .si {
    color: #d14; }
  .highlight .sx {
    color: #d14; }
  .highlight .sr {
    color: #009926; }
  .highlight .s1 {
    color: #d14; }
  .highlight .ss {
    color: #990073; }
  .highlight .bp {
    color: #999; }
  .highlight .vc {
    color: #008080; }
  .highlight .vg {
    color: #008080; }
  .highlight .vi {
    color: #008080; }
  .highlight .il {
    color: #099; }

img {
  max-width: 100%;
  height: auto;
  width: auto; }

.icon > svg {
  display: inline-block;
  width: 16px;
  height: 16px;
  vertical-align: middle; }
  .icon > svg path {
    fill: #828282; }

amp-img {
  background-color: grey; }

.cf:after {
  content: "";
  display: table;
  clear: both; }

main {
  display: block; }

body {
  font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 0;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-font-feature-settings: "liga=1, dlig=1";
  -ms-font-feature-settings: "liga", "dlig";
  -webkit-font-feature-settings: "liga", "dlig";
  -o-font-feature-settings: "liga", "dlig";
  font-feature-settings: "liga", "dlig"; }

.site-header {
  position: relative;
  width: 100%;
  max-width: 700px;
  margin: 16px auto 0 auto;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box; }
  @media only screen and (max-width: 800px) {
    .site-header {
      padding: 0 16px; } }
  .site-header .page-links {
    display: block;
    position: absolute;
    top: 10px;
    right: 16px;
    font-weight: 200;
    font-style: normal;
    font-size: 18px;
    line-height: 30px; }
    .site-header .page-links a {
      text-decoration: none;
      color: #999999; }
      .site-header .page-links a:hover {
        color: #333333; }

.page-notice {
  background-color: rgba(202, 185, 24, 0.1);
  padding: 9px;
  border: 1px solid #CAB918;
  border-radius: 2px;
  color: #867a10; }

.blog-title {
  margin-bottom: 8px;
  font-size: 40px;
  font-weight: 700;
  letter-spacing: -2px;
  outline: 0;
  line-height: 40px;
  word-break: break-word;
  color: #333333; }
  .blog-title a {
    text-decoration: none;
    color: #333333; }

.blog-header {
  width: 100%;
  max-width: 700px;
  margin: 0 auto;
  position: relative;
  padding: 0;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box; }

.content {
  width: 100%;
  max-width: 700px;
  margin: 25px auto 0 auto;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box; }
  @media only screen and (max-width: 800px) {
    .content {
      padding: 0 16px; } }
  .content article {
    padding: 20px 0;
    border-bottom: 1px solid #f2f2f0; }
    .content article:last-child {
      border-bottom: 0px; }
    .content article .post-title {
      letter-spacing: -0.02em;
      font-weight: 700;
      font-style: normal;
      display: block;
      font-size: 36px;
      line-height: 1.15;
      margin: 0 0; }
      .content article .post-title a {
        text-decoration: none;
        color: #333332; }
        .content article .post-title a:hover {
          text-decoration: none; }
    .content article .post-excerpt {
      letter-spacing: -0.02em;
      font-weight: 300;
      font-style: normal;
      font-size: 20px;
      line-height: 1.59;
      color: #666665; }
    .content article .post-meta {
      font-size: 14px;
      color: #b3b3b1;
      line-height: 30px; }
      .content article .post-meta a {
        color: #b3b3b1;
        text-decoration: none; }
        .content article .post-meta a:hover {
          text-decoration: underline; }

.post-template .content {
  max-width: 700px; }

.index-headline {
  border-top: 1px solid #dededc;
  margin: 0;
  padding: 16px 0; }
  .index-headline span {
    color: #b3b3b1;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px; }

.pagination {
  text-align: center;
  padding: 16px 0 0;
  margin-bottom: 40px;
  font-size: 12px; }
  .pagination a {
    color: #999999;
    text-decoration: none; }
    .pagination a:hover {
      color: #333333; }

.post .post-meta {
  font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
.post .post-title {
  font-weight: 700;
  font-style: normal;
  letter-spacing: -0.04em;
  font-size: 50px;
  line-height: 1.1;
  color: #333332;
  margin-bottom: 50px; }
.post .author-image {
  background-image: url(//assets/images/author.jpg);
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  margin-right: 8px;
  margin-bottom: -10px;
  float: left;
  background-size: cover;
  border-radius: 100%;
  text-indent: -9999px; }
.post .post-meta-text {
  color: #b3b3b1;
  letter-spacing: -0.02em;
  font-weight: 400;
  font-style: normal;
  font-size: 14px;
  overflow: hidden;
  font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif;
  white-space: nowrap;
  text-overflow: ellipsis; }
.post .post-content {
  width: 100%;
  font-family: Georgia, Cambria, "Times New Roman", Times, "Lora", serif;
  color: #333333; }
  .post .post-content h1, .post .post-content h2, .post .post-content h3 {
    font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
  .post .post-content h3, .post .post-content h4, .post .post-content h5, .post .post-content h6 {
    letter-spacing: -0.02em;
    font-weight: 700;
    font-style: normal;
    font-size: 24px;
    line-height: 1.3;
    margin-top: 50px;
    margin-bottom: 0px;
    font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; }
  .post .post-content h3 {
    font-size: 36px; }
  .post .post-content h2, .post .post-content h1 {
    letter-spacing: -0.02em;
    font-weight: 700;
    font-style: normal;
    font-size: 42px;
    line-height: 1.2;
    margin-top: 50px;
    margin-bottom: 0px; }
  .post .post-content p {
    font-weight: 400;
    font-style: normal;
    font-size: 22px;
    line-height: 1.59;
    letter-spacing: -.002em;
    margin-top: 30px;
    margin-bottom: 0;
    color: #333333;
    -webkit-hyphens: auto;
    -moz-hyphens: auto;
    hyphens: auto; }
  .post .post-content a {
    color: #333333;
    text-decoration: underline; }
  .post .post-content amp-img, .post .post-content amp-youtube {
    margin-top: 30px; }
  .post .post-content figure {
    margin: 0;
    padding: 0 0 30px; }
  .post .post-content figcaption {
    font-weight: 400;
    font-style: italic;
    font-size: 16px;
    line-height: 1.3;
    color: #666665;
    outline: 0;
    z-index: 300;
    text-align: center; }
  .post .post-content hr {
    border: 0;
    padding: 0;
    display: block;
    width: 15%;
    margin: 30px auto;
    border: 0px solid #dddddd;
    border-top: 1px solid #dddddd; }
  .post .post-content blockquote {
    margin: 0 0 30px;
    margin-left: -26px;
    border-left: 3px solid #57ad68;
    padding-left: 20px; }
    .post .post-content blockquote p {
      letter-spacing: 0.01rem;
      font-weight: 400;
      mborder-left: 3px solid #57ad68;
      mpadding-left: 20px;
      mmargin-left: -26px;
      padding-bottom: 3px; }
  .post .post-content ul, .post .post-content ol {
    padding: 0 0 30px;
    margin: 0; }
  .post .post-content li {
    padding: 0;
    font-weight: 400;
    font-style: normal;
    font-size: 23px;
    line-height: 30px;
    margin-left: 30px;
    margin-bottom: 12px;
    padding-top: 2px; }
    .post .post-content li p {
      padding: 0 0 1.618rem; }
  .post .post-content ol li {
    list-style-type: decimal; }

.share {
  text-align: right;
  padding: 20px 0 0; }
  .share a {
    text-decoration: none;
    color: #bbbbbb;
    padding-left: 12px; }
    .share a .hidden {
      display: none; }
    .share a:hover {
      color: #333333; }

pre,
code {
  font-size: 15px;
  border: 1px solid #e8e8e8;
  border-radius: 3px;
  background-color: #eeeeff; }

code {
  padding: 1px 5px; }

pre {
  padding: 8px 12px;
  overflow-x: scroll; }
  pre > code {
    border: 0;
    padding-right: 0;
    padding-left: 0; }

@media (max-width: 550px) {
  .site-header .page-links {
    position: static; } }

  </style>



  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
  <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

  <body>
    <header class="site-header">
  <h1 class="blog-title"><a href="/">JedenBod</a></h1>

  <div class="page-notice">
    Tento blog je opuštěn a přežívá pouze záloha. Většina informací zde je nejspíše zastaralých.
  </div>

  <div class="page-links">
    <a class="page-link" href="/">Domů</a>
    • <a class="page-link" href="http://mikul.as">Jakub Mikuláš</a>
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  </div>
</header>


    <main class="content" role="main">
  <article class="post">
    <div class="post-meta">
      <h1 class="post-title">Knihovny třetích stran v Angularu</h1>
    </div>

    <section class="post-content">
      <a name="topofpage"></a>
      <p>Při stavění <a href="http://clickandstudy.com">Click and Study</a> s <a href="https://www.dwgroup.cz">Digital Wizards</a> jsem narazil na to, že moje Angular aplikace závisela na hned několika knihovnách 3. strany. Firebase, Facebook SDK, Keen.io, Recurly atd.</p>

<p>Žádná z nich není nutná pro start aplikace, takže nemá smysl je přidávat hned na začátku nebo je mít součástí build procesu. Angular takovou funkci defaultně nemá, takže si musíme vytvořit vlastní službu.</p>

<h2 id="minimlneen">Minimální řešení</h2>

<p>Vždycky rád začínám s minimálním řešením/mockem, abych vůbec věděl, jak ho budu používat.</p>

<p>Každou knihovnu budeme chtít načíst pouze jednou, což zajistíme tím, že budeme kontrolovat, jestli už je v okně zaregistrován její globální objekt, načež spustíme callback. Nevyužívám <a href="https://docs.angularjs.org/api/ng/service/$document">$document</a>, protože neumí createElement a volání přes <a href="https://docs.angularjs.org/api/ng/function/angular.element">angular.element</a> se mi moc nelíbil.</p>

<figure class="highlight">
  <pre><code class="language-js" data-lang="js"><span class="cm">/**
     * Load JavaScript file, if his global name isn't registered already
     * @param  {string}   scriptUrl   URL to JS file
     * @param  {string}   nameToCheck Name that should be checked in global scope
     * @param  {Function} callback    Callback function on success
     */</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s2">"loadJS"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$window</span><span class="p">)</span> <span class="p">{</span>
    	<span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scriptUrl</span><span class="p">,</span> <span class="nx">nameToCheck</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">$window</span><span class="p">[</span><span class="nx">nameToCheck</span><span class="p">]</span> <span class="o">!==</span> <span class="s2">"undefined"</span><span class="p">)</span> <span class="p">{</span>
    			<span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    		<span class="p">}</span>

    		<span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"script"</span><span class="p">);</span>
    		<span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">scriptUrl</span><span class="p">;</span>
    		<span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
    		<span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
    	<span class="p">};</span>
    <span class="p">});</span>
    </code></pre>
</figure>

<p>Použití je potom přímočaré:</p>

<figure class="highlight">
  <pre><code class="language-js" data-lang="js"><span class="nx">loadJS</span><span class="p">(</span><span class="s2">"//cdn.firebase.com/js/client/1.0.21/firebase.js"</span><span class="p">,</span> <span class="s2">"Firebase"</span><span class="p">,</span> <span class="nx">loadNotifications</span><span class="p">);</span>
    </code></pre>
</figure>

<p>Jenže, pro takovéto asynchronní operace se více hodí promise a Angular služba $q.</p>

<h2 id="een-s-q">Řešení s $q</h2>

<p>Předělání na <a href="https://docs.angularjs.org/api/ng/service/$q">promise</a> je jednoduchá záležitost. Navíc získáme jednodušší error handling a možnost navazovat další větve s konstruktem .then(). Takže je například jednodušší načíst knihovnu, inicializovat a až potom použít.</p>

<figure class="highlight">
  <pre><code class="language-js" data-lang="js"><span class="cm">/**
     * Load JavaScript file, if his global name isn't registered already
     * @param  {string}   scriptUrl   URL to JS file
     * @param  {string}   nameToCheck Name that should be checked in global scope
     * @return {promise}              Promise
     */</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s2">"loadJS"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$window</span><span class="p">,</span> <span class="nx">$log</span><span class="p">)</span> <span class="p">{</span>
    	<span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scriptUrl</span><span class="p">,</span> <span class="nx">nameToCheck</span><span class="p">)</span> <span class="p">{</span>
    		<span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">$window</span><span class="p">[</span><span class="nx">nameToCheck</span><span class="p">]</span> <span class="o">!==</span> <span class="s2">"undefined"</span><span class="p">)</span> <span class="p">{</span>
    			<span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    		<span class="p">}</span>

    		<span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"script"</span><span class="p">);</span>
    		<span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">scriptUrl</span><span class="p">;</span>
    		<span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    			<span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    		<span class="p">};</span>
    		<span class="nx">script</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    			<span class="nx">$log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">"Failed to load script: "</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
    			<span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    		<span class="p">}</span>
    		<span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>

    		<span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
    	<span class="p">};</span>
    <span class="p">});</span>
    </code></pre>
</figure>

<p>Což nám umožní knihovny volat takto:</p>

<figure class="highlight">
  <pre><code class="language-js" data-lang="js"><span class="nx">loadJS</span><span class="p">(</span><span class="s2">"//cdn.firebase.com/js/client/1.0.21/firebase.js"</span><span class="p">,</span> <span class="s2">"Firebase"</span><span class="p">)</span>
    	<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">setupFirebase</span><span class="p">)</span>
    	<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">loadNotifications</span><span class="p">)</span>
    	<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    		<span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">"Failed to load script: "</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
    	<span class="p">});</span>
    </code></pre>
</figure>

<h2 id="unit-test">Unit test</h2>

<p>Jasmine test pro $q je také <em>skoro</em> přímočará záležitost. Stačí si jen dát pozor na to, že Angular dělá resolve při <code class="highlighter-rouge">$rootScope.$apply();</code> a že zaregistrování <code class="highlighter-rouge">onerror</code> chyby potřebuje obalit vyhodnocení do <code class="highlighter-rouge">setTimeout()</code></p>

<figure class="highlight">
  <pre><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">'loadJS service'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$scope</span><span class="p">,</span>
            <span class="nx">loadJS</span><span class="p">,</span>
            <span class="nx">$window</span><span class="p">,</span>
            <span class="nx">handler</span><span class="p">,</span>
            <span class="nx">controller</span><span class="p">;</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">module</span><span class="p">(</span><span class="s1">'app'</span><span class="p">);</span>

            <span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_$q_</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">_$window_</span><span class="p">,</span> <span class="nx">$controller</span><span class="p">,</span> <span class="nx">_loadJS_</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">handler</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="na">thenPromise</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>
                    <span class="na">catchPromise</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
                <span class="p">};</span>
                <span class="nx">loadJS</span> <span class="o">=</span> <span class="nx">_loadJS_</span><span class="p">;</span>
                <span class="nx">$window</span> <span class="o">=</span> <span class="nx">_$window_</span><span class="p">;</span>
                <span class="nx">$scope</span> <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$new</span><span class="p">();</span>
                <span class="nx">controller</span> <span class="o">=</span> <span class="nx">$controller</span><span class="p">(</span><span class="s1">'mainController'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s1">'$scope'</span><span class="p">:</span> <span class="nx">$scope</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'Service loaded'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">loadJS</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s2">"Reject promise"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">spyOn</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s2">"catchPromise"</span><span class="p">);</span>
            <span class="nx">loadJS</span><span class="p">(</span><span class="s2">"xxx"</span><span class="p">,</span> <span class="s2">"TEST"</span><span class="p">)</span> <span class="c1">// this should throw onerror call</span>
                <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">catchPromise</span><span class="p">);</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// let's wait for deferred call, so code coverage is happy</span>
                <span class="nx">$scope</span><span class="p">.</span><span class="nx">$root</span><span class="p">.</span><span class="nx">$apply</span><span class="p">();</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">catchPromise</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
                <span class="nx">done</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s2">"Resolve promise"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">spyOn</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s2">"thenPromise"</span><span class="p">);</span>
            <span class="nx">$window</span><span class="p">.</span><span class="nx">TEST</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">loadJS</span><span class="p">(</span><span class="s2">"http://example.com/script.js"</span><span class="p">,</span> <span class="s2">"TEST"</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">thenPromise</span><span class="p">);</span>
            <span class="nx">$scope</span><span class="p">.</span><span class="nx">$root</span><span class="p">.</span><span class="nx">$apply</span><span class="p">();</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">thenPromise</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">});</span>
    </code></pre>
</figure>

<p>Tento test také zajistí 100% code coverage v <a href="http://gotwarlost.github.io/istanbul/">Istanbulu</a>.</p>

<p><img src="http://jedenbod.cz/wp-content/uploads/2014/12/Snímek-obrazovky-2014-12-21-v-23.57.02.png" alt="AngularJS - loadJS code coverage" /></p>

    </section>
  </article>
</main>


    <amp-analytics type="googleanalytics" id="analytics1">
    <script type="application/json">
    {
      "vars": {
        "account": "UA-7258637"
      },
      "triggers": {
        "trackPageview": {
          "on": "visible",
          "request": "pageview"
        }
      }
    }
    </script>
    </amp-analytics>
  </body>
</html>
